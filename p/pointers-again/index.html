<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Pointer arithmetics It is well-known that in both C and C++, pointer arithmetics is only meaningful for operands (and the imaginary resultant pointer address) that are related to each other. By related we mean, they both point to the same object (or one-past-end), or the same array (or one-past-end).\nPer C++ standard, pointers are iterators, not numbers representing address space, although they&rsquo;re often implemented as such.\nTo quote https://stackoverflow.com/a/56038995/17815599:\nSpeaking more academically:\u00a0pointers are not numbers. They are pointers.\n"><title>Pointers (again)</title><link rel=canonical href=https://kya8.github.io/p/pointers-again/><link rel=stylesheet href=/scss/style.min.8659d82dbe8d0fe183ef22445ed42765c7d1d996ae5b4a02725eda69426286da.css><meta property='og:title' content="Pointers (again)"><meta property='og:description' content="Pointer arithmetics It is well-known that in both C and C++, pointer arithmetics is only meaningful for operands (and the imaginary resultant pointer address) that are related to each other. By related we mean, they both point to the same object (or one-past-end), or the same array (or one-past-end).\nPer C++ standard, pointers are iterators, not numbers representing address space, although they&rsquo;re often implemented as such.\nTo quote https://stackoverflow.com/a/56038995/17815599:\nSpeaking more academically:\u00a0pointers are not numbers. They are pointers.\n"><meta property='og:url' content='https://kya8.github.io/p/pointers-again/'><meta property='og:site_name' content="Kya's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='c'><meta property='article:tag' content='c++'><meta property='article:published_time' content='2023-01-04T00:00:00+00:00'><meta property='article:modified_time' content='2024-06-02T00:00:00+00:00'><meta name=twitter:title content="Pointers (again)"><meta name=twitter:description content="Pointer arithmetics It is well-known that in both C and C++, pointer arithmetics is only meaningful for operands (and the imaginary resultant pointer address) that are related to each other. By related we mean, they both point to the same object (or one-past-end), or the same array (or one-past-end).\nPer C++ standard, pointers are iterators, not numbers representing address space, although they&rsquo;re often implemented as such.\nTo quote https://stackoverflow.com/a/56038995/17815599:\nSpeaking more academically:\u00a0pointers are not numbers. They are pointers.\n"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/>Kya's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/kya8 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#pointer-arithmetics>Pointer arithmetics</a><ol><li><a href=#what-are-arrays>what are &ldquo;arrays&rdquo;?</a></li><li><a href=#pointer-to-struct-member>pointer to struct member</a><ol><li><a href=#padding>Padding</a></li></ol></li><li><a href=#pointer-in-nested-arrays>pointer in nested arrays</a></li></ol></li><li><a href=#pointer-to-first-member-of-standard-layout-struct>Pointer to first member of (standard layout) struct</a></li><li><a href=#pointer-total-order>Pointer total order</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/pointers-again/>Pointers (again)</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 04, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><h1 id=pointer-arithmetics>Pointer arithmetics</h1><p>It is well-known that in both C and C++, pointer arithmetics is only meaningful for operands (and the imaginary resultant pointer address) that are related to each other.
By related we mean, they both point to the same object (or one-past-end), or the same array (or one-past-end).</p><p>Per C++ standard, pointers are <em>iterators</em>, not <em>numbers representing address space</em>, although they&rsquo;re often implemented as such.</p><p>To quote <a class=link href=https://stackoverflow.com/a/56038995/17815599 target=_blank rel=noopener>https://stackoverflow.com/a/56038995/17815599</a>:</p><blockquote><p>Speaking more academically: <strong>pointers are not numbers</strong>. They are pointers.</p><p>It is true that a pointer on your system is implemented as a numerical representation of an address-like representation of a location in some abstract kind of memory (probably a virtual, per-process memory space).</p><p>But C++ doesn&rsquo;t care about that. C++ wants you to think of pointers as post-its, as bookmarks, to specific objects. The numerical address values are just a side-effect. The <em>only</em> arithmetic that makes sense on a pointer is <em>forwards and backwards</em> through an array of objects; nothing else is philosophically meaningful.</p></blockquote><p>So, <code>p1 - p0</code> isn&rsquo;t really saying &ldquo;give me the difference between the addresses pointed by <code>p1</code> and <code>p0</code>&rdquo;,
it&rsquo;s saying &ldquo;Assuming they both refer to objects in the same array, what&rsquo;s the difference between their indices inside the array?&rdquo;
(Here, we consider a single object as an array of length one). If the assumption does not hold, this is undefined behavior.
For relational (greater than, less than&mldr;) comparisons however, the behavior is <em>unspecified</em>.</p><h2 id=what-are-arrays>what are &ldquo;arrays&rdquo;?</h2><p>It covers a bit wider than normal (i.e. <code>int arr[]</code>) arrays.
In particular, pointer returned by <code>malloc</code> can be addressed as arrays.</p><p>Also see <a class=link href=https://stackoverflow.com/questions/47830449/can-you-do-arithmetic-on-a-char-pointing-at-another-object target=_blank rel=noopener>https://stackoverflow.com/questions/47830449/can-you-do-arithmetic-on-a-char-pointing-at-another-object</a> for aliasing <code>char*</code> pointers.</p><h2 id=pointer-to-struct-member>pointer to struct member</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>xyz_s</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>float</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>xyz_s</span> <span class=n>pt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>px</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>pt</span><span class=p>.</span><span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>py</span> <span class=o>=</span> <span class=n>px</span> <span class=o>+</span> <span class=mi>1</span> <span class=c1>// ???
</span></span></span></code></pre></td></tr></table></div></div><p><code>xyz</code> is standard-layout type, which means it has C-like memory layout. However in this example, <em>even if the struct <code>xyz_s</code> does not contain any paddings</em>, <code>py</code> does not actually point to <code>pt.y</code>. It points to &ldquo;one-past-end&rdquo; of <code>pt.x</code>!
That&rsquo;s because there&rsquo;re no arrays here, so <code>py</code> can only be the &ldquo;one-past-end&rdquo; pointer of <code>pt.x</code>. Although evaluating <code>px+1</code> is well-defined, dereferencing the resultant <code>py</code> is UB. It&rsquo;s not <code>pt.y</code>!</p><p>If we change <code>xyz_s</code> to contain an array of 3 floats, that kind of pointer arithmetic is okay. Also absence of padding in array is guaranteed.</p><h3 id=padding>Padding</h3><p>Actually, the compiler is free to insert paddings inside a struct in an implementation-defined way, <strong>except at the beginning</strong> of a struct. There&rsquo;s nothing in the standard mandating no paddings in <code>xyz_s</code>!</p><p>This is also why there&rsquo;s no guaranteed size for <code>std::array&lt;T, N></code>. Even if it only contains a single member <code>T data_[N]</code>, the compiler can still insert paddings after it.</p><h2 id=pointer-in-nested-arrays>pointer in nested arrays</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Pt3</span> <span class=p>{</span> <span class=kt>float</span> <span class=n>xyz</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>xyz_s</span><span class=o>&gt;</span> <span class=n>vec</span><span class=p>(</span><span class=n>N</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>p0x</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>vec</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>xyz</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>p0z</span> <span class=o>=</span> <span class=n>p0x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>;</span> <span class=c1>// okay
</span></span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>p1x</span> <span class=o>=</span> <span class=n>p0z</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// bad
</span></span></span></code></pre></td></tr></table></div></div><p>Here, <code>p1x</code> is still one-past-end of <code>vec[0].xyz[2]</code>. Because, there&rsquo;s no array of type <code>float</code> and length <code>N*3</code>! And consider possible paddings mentioned above.</p><h1 id=pointer-to-first-member-of-standard-layout-struct>Pointer to first member of (standard layout) struct</h1><p>(By &ldquo;first&rdquo; we mean the first declared member)</p><p>Ref: <a class=link href=https://en.cppreference.com/w/cpp/language/static_cast#Pointer-interconvertible_objects target=_blank rel=noopener>https://en.cppreference.com/w/cpp/language/static_cast#Pointer-interconvertible_objects</a></p><p>Two objects a and b are <em>pointer-interconvertible</em> if:</p><ul><li>they are the same object, or</li><li>one is a union object and the other is a non-static data member of that object, or</li><li>one is a standard-layout class object and the other is the first non-static data member of that object or any base class subobject of that object, or</li><li>there exists an object c such that a and c are pointer-interconvertible, and c and b are pointer-interconvertible.</li></ul><p>&mldr;combined with pointer conversion rules, it&rsquo;s possible to convert between pointer to a standard-layout struct and pointer to its first member, via an intermediate <code>void*</code> pointer.</p><h1 id=pointer-total-order>Pointer total order</h1><p>There is actually one exception to the &ldquo;same-object-or-array&rdquo; rule: the total order of pointers in C++.
It only applies to comparison functors, <code>std::less</code>, <code>std::greater</code> etc. This total order is consistent with defined pointer comparison rules of the built-in comparison operators.
For the unspecified case, the result becomes implementation-defined.</p><p>Note that in C, relational comparison of unrelated pointers is <em>undefined</em>.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/c/>C</a>
<a href=/tags/c++/>C++</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Jun 02, 2024 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/%E4%B8%8D%E7%94%A8%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0opaque-struct%E5%92%8Cpimpl/><div class=article-details><h2 class=article-title>不用动态内存分配如何实现opaque struct和PIMPL?</h2></div></a></article><article><a href=/p/signed%E4%B8%8Eunsigned%E6%95%B4%E5%9E%8B/><div class=article-details><h2 class=article-title>Signed与Unsigned整型</h2></div></a></article><article><a href=/p/portable-signal-handling/><div class=article-details><h2 class=article-title>Portable Signal handling</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 Kya's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>