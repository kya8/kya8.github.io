<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="(这只是一个记录贴. 最近又需要在Linux机器上弄一台Windows开发虚拟机, 遂翻出了几年前的记录, 并针对较新的Qemu版本做了一些更新.)\nTL;DR Qemu命令行参数:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 qemu-system-x86_64 -accel kvm -machine q35 -name windows \\ -cpu host,hv_relaxed,hv_spinlocks=0x1fff,hv_vapic,hv_vpindex,hv_synic,hv_time,hv_stimer,hv_tlbflush,hv_tlbflush_ext,hv_ipi,hv_stimer_direct,hv_runtime,hv_frequencies,hv_reenlightenment,hv_avic,hv_xmm_input,hv_evmcs \\ -smp sockets=1,cores=8,threads=1 \\ -m 8G \\ -rtc base=localtime \\ -drive if=pflash,format=raw,readonly=on,file=OVMF_CODE.fd -drive if=pflash,format=raw,file=OVMF_VARS.fd \\ -device virtio-balloon \\ -vga none -device virtio-vga \\ # qxl: -device qxl-vga,xres=1920,yres=1080,vgamem_mb=32 -audiodev pipewire,id=snd0 -device ich9-intel-hda -device hda-output,audiodev=snd0 \\ -device qemu-xhci,id=xhci -device usb-tablet \\ -drive file=disk0.qcow2,if=virtio,discard=unmap \\ -nic user,model=virtio-net-pci,guestfwd=tcp::1080-tcp:127.0.0.1:1080 \\ # virtiofs share -object memory-backend-memfd,id=mem,size=8G,share=on -numa node,memdev=mem -chardev socket,id=char0,path=/tmp/vm-share -device vhost-user-fs-pci,chardev=char0,tag=my-share \\ # For installing Windows -drive file=windows.iso,index=2,media=cdrom \\ -drive file=virtio-win.iso,index=3,media=cdrom Virtiofsd:\n"><title>Qemu windows guest best practices</title><link rel=canonical href=https://kya8.github.io/p/qemu-windows-guest-best-practices/><link rel=stylesheet href=/scss/style.min.95d2cc3c53057e0ce2ff257d4913db2ead814a3b31c640724a5fdf4f8d5a6298.css><meta property='og:title' content="Qemu windows guest best practices"><meta property='og:description' content="(这只是一个记录贴. 最近又需要在Linux机器上弄一台Windows开发虚拟机, 遂翻出了几年前的记录, 并针对较新的Qemu版本做了一些更新.)\nTL;DR Qemu命令行参数:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 qemu-system-x86_64 -accel kvm -machine q35 -name windows \\ -cpu host,hv_relaxed,hv_spinlocks=0x1fff,hv_vapic,hv_vpindex,hv_synic,hv_time,hv_stimer,hv_tlbflush,hv_tlbflush_ext,hv_ipi,hv_stimer_direct,hv_runtime,hv_frequencies,hv_reenlightenment,hv_avic,hv_xmm_input,hv_evmcs \\ -smp sockets=1,cores=8,threads=1 \\ -m 8G \\ -rtc base=localtime \\ -drive if=pflash,format=raw,readonly=on,file=OVMF_CODE.fd -drive if=pflash,format=raw,file=OVMF_VARS.fd \\ -device virtio-balloon \\ -vga none -device virtio-vga \\ # qxl: -device qxl-vga,xres=1920,yres=1080,vgamem_mb=32 -audiodev pipewire,id=snd0 -device ich9-intel-hda -device hda-output,audiodev=snd0 \\ -device qemu-xhci,id=xhci -device usb-tablet \\ -drive file=disk0.qcow2,if=virtio,discard=unmap \\ -nic user,model=virtio-net-pci,guestfwd=tcp::1080-tcp:127.0.0.1:1080 \\ # virtiofs share -object memory-backend-memfd,id=mem,size=8G,share=on -numa node,memdev=mem -chardev socket,id=char0,path=/tmp/vm-share -device vhost-user-fs-pci,chardev=char0,tag=my-share \\ # For installing Windows -drive file=windows.iso,index=2,media=cdrom \\ -drive file=virtio-win.iso,index=3,media=cdrom Virtiofsd:\n"><meta property='og:url' content='https://kya8.github.io/p/qemu-windows-guest-best-practices/'><meta property='og:site_name' content="Kya's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='qemu'><meta property='article:tag' content='windows'><meta property='article:published_time' content='2024-03-12T00:00:00+00:00'><meta property='article:modified_time' content='2025-07-06T00:00:00+00:00'><meta name=twitter:title content="Qemu windows guest best practices"><meta name=twitter:description content="(这只是一个记录贴. 最近又需要在Linux机器上弄一台Windows开发虚拟机, 遂翻出了几年前的记录, 并针对较新的Qemu版本做了一些更新.)\nTL;DR Qemu命令行参数:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 qemu-system-x86_64 -accel kvm -machine q35 -name windows \\ -cpu host,hv_relaxed,hv_spinlocks=0x1fff,hv_vapic,hv_vpindex,hv_synic,hv_time,hv_stimer,hv_tlbflush,hv_tlbflush_ext,hv_ipi,hv_stimer_direct,hv_runtime,hv_frequencies,hv_reenlightenment,hv_avic,hv_xmm_input,hv_evmcs \\ -smp sockets=1,cores=8,threads=1 \\ -m 8G \\ -rtc base=localtime \\ -drive if=pflash,format=raw,readonly=on,file=OVMF_CODE.fd -drive if=pflash,format=raw,file=OVMF_VARS.fd \\ -device virtio-balloon \\ -vga none -device virtio-vga \\ # qxl: -device qxl-vga,xres=1920,yres=1080,vgamem_mb=32 -audiodev pipewire,id=snd0 -device ich9-intel-hda -device hda-output,audiodev=snd0 \\ -device qemu-xhci,id=xhci -device usb-tablet \\ -drive file=disk0.qcow2,if=virtio,discard=unmap \\ -nic user,model=virtio-net-pci,guestfwd=tcp::1080-tcp:127.0.0.1:1080 \\ # virtiofs share -object memory-backend-memfd,id=mem,size=8G,share=on -numa node,memdev=mem -chardev socket,id=char0,path=/tmp/vm-share -device vhost-user-fs-pci,chardev=char0,tag=my-share \\ # For installing Windows -drive file=windows.iso,index=2,media=cdrom \\ -drive file=virtio-win.iso,index=3,media=cdrom Virtiofsd:\n"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/>Kya's Blog</a></h1><h2 class=site-description>Place where I post random stuff</h2></div></header><ol class=menu-social><li><a href=https://github.com/kya8 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#tldr>TL;DR</a></li><li><a href=#关于qemu命令行>关于Qemu命令行</a></li><li><a href=#参数说明>参数说明</a><ol><li><a href=#芯片组和cpu>芯片组和CPU</a></li><li><a href=#uefi固件>UEFI固件</a></li><li><a href=#显卡>显卡</a></li><li><a href=#声音>声音</a></li><li><a href=#usb-输入>USB, 输入</a></li><li><a href=#存储>存储</a><ol><li><a href=#trim>TRIM</a></li><li><a href=#安装盘>安装盘</a></li></ol></li><li><a href=#网络>网络</a></li><li><a href=#virtiofs文件共享>virtiofs文件共享</a></li><li><a href=#其它>其它</a></li></ol></li><li><a href=#结果>结果</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/linux/ style=background-color:#243252;color:#fff>Linux</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/qemu-windows-guest-best-practices/>Qemu windows guest best practices</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 12, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>2 minute read</time></div></footer></div></header><section class=article-content><p>(这只是一个记录贴. 最近又需要在Linux机器上弄一台Windows开发虚拟机, 遂翻出了几年前的记录, 并针对较新的Qemu版本做了一些更新.)</p><h1 id=tldr>TL;DR</h1><p>Qemu命令行参数:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>qemu-system-x86_64 -accel kvm -machine q35 -name windows <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-cpu host,hv_relaxed,hv_spinlocks<span class=o>=</span>0x1fff,hv_vapic,hv_vpindex,hv_synic,hv_time,hv_stimer,hv_tlbflush,hv_tlbflush_ext,hv_ipi,hv_stimer_direct,hv_runtime,hv_frequencies,hv_reenlightenment,hv_avic,hv_xmm_input,hv_evmcs <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-smp <span class=nv>sockets</span><span class=o>=</span>1,cores<span class=o>=</span>8,threads<span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-m 8G <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-rtc <span class=nv>base</span><span class=o>=</span>localtime <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-drive <span class=k>if</span><span class=o>=</span>pflash,format<span class=o>=</span>raw,readonly<span class=o>=</span>on,file<span class=o>=</span>OVMF_CODE.fd -drive <span class=k>if</span><span class=o>=</span>pflash,format<span class=o>=</span>raw,file<span class=o>=</span>OVMF_VARS.fd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-device virtio-balloon <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-vga none -device virtio-vga <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=c1># qxl: -device qxl-vga,xres=1920,yres=1080,vgamem_mb=32</span>
</span></span><span class=line><span class=cl>-audiodev pipewire,id<span class=o>=</span>snd0 -device ich9-intel-hda -device hda-output,audiodev<span class=o>=</span>snd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-device qemu-xhci,id<span class=o>=</span>xhci -device usb-tablet <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-drive <span class=nv>file</span><span class=o>=</span>disk0.qcow2,if<span class=o>=</span>virtio,discard<span class=o>=</span>unmap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-nic user,model<span class=o>=</span>virtio-net-pci,guestfwd<span class=o>=</span>tcp::1080-tcp:127.0.0.1:1080 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=c1># virtiofs share</span>
</span></span><span class=line><span class=cl>-object memory-backend-memfd,id<span class=o>=</span>mem,size<span class=o>=</span>8G,share<span class=o>=</span>on -numa node,memdev<span class=o>=</span>mem -chardev socket,id<span class=o>=</span>char0,path<span class=o>=</span>/tmp/vm-share -device vhost-user-fs-pci,chardev<span class=o>=</span>char0,tag<span class=o>=</span>my-share <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=c1># For installing Windows</span>
</span></span><span class=line><span class=cl>-drive <span class=nv>file</span><span class=o>=</span>windows.iso,index<span class=o>=</span>2,media<span class=o>=</span>cdrom <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-drive <span class=nv>file</span><span class=o>=</span>virtio-win.iso,index<span class=o>=</span>3,media<span class=o>=</span>cdrom
</span></span></code></pre></td></tr></table></div></div><p>Virtiofsd:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/usr/libexec/virtiofsd --socket-path<span class=o>=</span>/tmp/virtiofs-share.sock --shared-dir /path/to/shared/dir
</span></span></code></pre></td></tr></table></div></div><h1 id=关于qemu命令行>关于Qemu命令行</h1><p>推荐阅读: <a class=link href=https://archive.fosdem.org/2018/schedule/event/vai_qemu_jungle/ target=_blank rel=noopener>https://archive.fosdem.org/2018/schedule/event/vai_qemu_jungle/</a></p><p>Qemu的一些选项经常让新手困惑, 主要原因其实就是:</p><ol><li><p>Qemu模拟的每个虚拟设备都由host backend和guest device两部分组成. 两部分一般用一个名字(id)相联系.
诸如<code>-nic</code>, <code>-drive</code>之类的选项只是为了便利提供的shortcut, 能够同时配置两部分.</p><p>例如, <code>-nic user,model=virtio-net-pci</code>的完整写法是<code>--device virtio-net-pci,netdev=n1 --netdev user,id=n1</code></p></li><li><p>Qemu的一个system emulator一般会有一些默认模拟的设备, 即使不加任何命令行参数都会被模拟. 例如, x86的system emulator默认会模拟一个vga显卡等.</p></li></ol><h1 id=参数说明>参数说明</h1><h2 id=芯片组和cpu>芯片组和CPU</h2><p>x86-64上一般使用q35机型即可.
<code>-cpu host</code>表示使用主机的CPU型号, 并且会开启对应的指令集支持. 后面的一串<code>hv_*</code>是hyper-v enlightments, 适用于Windows客户机.</p><p>用<code>-smp</code>选项可指定CPU的拓扑关系, 这里指定一枚CPU, 8个核心, 每个核心有1个线程.</p><h2 id=uefi固件>UEFI固件</h2><p>利用OVMF提供的edk2固件, 实现UEFI启动. 一般发行版都会打包OVMF固件, 没有的话可以从网上下载.
固件分为只读和可写两部分, 以<code>pflash</code>形式添加.</p><h2 id=显卡>显卡</h2><p>Qemu给x86客机默认模拟的是一个基本的VGA设备, 足以用于Windows客机显示.
除此之外可选的是<code>virtio-vga</code>和<code>qxl-vga</code>. 前者可选择OpenGL加速(基于API转发, 目前对Windows无效), 后者主要用于给SPICE远程连接.</p><p>它们都是兼容VGA的, 在virtio驱动iso里包含对应的驱动. 这些Windows驱动都是DoD(Display only driver)驱动, 没有Windows上的图形加速功能, 用处不大, 功能上和基本的VGA无异.</p><p>参看: <a class=link href=https://www.kraxel.org/blog/2019/09/display-devices-in-qemu/ target=_blank rel=noopener>https://www.kraxel.org/blog/2019/09/display-devices-in-qemu/</a> (很有价值的blog, 来自qemu开发者)</p><p>(如果要求图形性能, 还是需要GPU直通或GPU虚拟化, 目前Qemu中没有虚拟显卡能给Windows客机提供较好的图形加速.
不过, 我们的目的仅是一个Windows开发机, 普通的VGA显示已足够.)</p><h2 id=声音>声音</h2><p>主机Backend部分上面选择了pipewire. 此外也可以用pulseaudio等. <code>-device ich9-intel-hda -device hda-output,audiodev=snd0</code>添加了两个客机设备, 分别是audio controller和audio codec, 和前面的backend id对应.</p><h2 id=usb-输入>USB, 输入</h2><p>一些芯片组(包括q35)具有自带的USB支持, 可用<code>-usb</code>开启.
但这里我们选择了<code>qemu-xhci</code>, qemu实现的一个通用的USB 3.0总线设备.</p><p>鼠标输入采用<code>usb-tablet</code>.
tablet设备的用处类似于触摸屏, 即Qemu无需grab input, 鼠标划过Qemu显示窗口时, 就自动输入到客机桌面中.</p><p>键盘方面, Qemu的x86 system emulator会默认模拟, 不需要手动添加.</p><h2 id=存储>存储</h2><p>直接使用一块virtio-scsi硬盘: <code>-drive file=disk0.qcow2,if=virtio,discard=unmap</code></p><p><code>if=virtio</code>在较早版本的Qemu上应该是<code>virtio-blk</code>驱动.
新版本的Qemu里则默认是<code>virtio-scsi</code>总线上的scsi硬盘, 相当于:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-drive if=none,id=hd1,format=qcow2,file=disk0.qcow2,discard=unmap
</span></span><span class=line><span class=cl>-device scsi-hd,drive=hd1
</span></span></code></pre></td></tr></table></div></div><p>qcow2硬盘镜像可用<code>qemu-img</code>自行创建.</p><h3 id=trim>TRIM</h3><p><code>virtio-scsi</code>以及<code>virtio-blk</code>存储设备均支持TRIM指令(即scsi标准中的unmap), 可用<code>discard=unmap</code>开启.
通过这种方式, 客机能直接告知主机, 存储中的哪些部分已经不再使用, 可以释放.
在这之前, 常见的老办法是在客机内写入一个全部为0的大文件, 直到把硬盘填满, 再把这个文件删除,
此时硬盘上的空闲空间应该全部是0, 随后将主机上的镜像文件转为稀疏文件.</p><p>对于不同的主机存储backend, 收到来自客机的TRIM指令后的处理方式也不同.
对于qcow2和raw镜像文件, Qemu的处理方式是给文件中被trim的空闲部分punch hole, 使之成为稀疏文件, 从而减少镜像文件的实际硬盘占用.
这一点可用<code>ls -lhs</code>或<code>du disk0.qcow2 ; du --apparent-size disk0.qcow2</code>来验证.</p><p>Windows客机在删除文件时会自动trim.
也可以使用自带的硬盘优化工具给硬盘手动trim, 其中虚拟硬盘会被显示为"Thin provisioned drive".</p><p><img src=/p/qemu-windows-guest-best-practices/windows-trim.png width=704 height=507 srcset="/p/qemu-windows-guest-best-practices/windows-trim_hu_b1eb9a237c24b1b2.png 480w, /p/qemu-windows-guest-best-practices/windows-trim_hu_6846417f600d2848.png 1024w" loading=lazy alt=Windows硬盘优化工具显示 class=gallery-image data-flex-grow=138 data-flex-basis=333px></p><h3 id=安装盘>安装盘</h3><p>安装时, 我们需要以cdrom形式添加windows的安装iso, 以及包含virtio windows驱动的iso.
安装过程中, 需要先加载virtio存储驱动, 才能看到硬盘并继续安装.</p><h2 id=网络>网络</h2><p>如果在意网络性能, 最好是使用一个由主机上的一个虚拟interface back的tap设备.
简便起见, 这里使用了qemu自带的user-mode networking, 作为主机backend.
客机设备则是virtio网卡, 需要安装对应驱动.</p><p>user-mode networking自带了端口转发功能, 两个方向均可. 上面的配置是把客机发向虚拟内网中主机(网关)<code>1080</code>端口的tcp包转发到本机的<code>127.0.0.1:1080</code>处.</p><h2 id=virtiofs文件共享>virtiofs文件共享</h2><p>目前Qemu上性能最好的共享文件方案就是virtiofs, 它是基于共享内存实现, 性能远高于9pfs或者其它基于网络层的方案.</p><ul><li><p>客机部分: Windows上的virtiofs文件系统驱动是用WinFsp实现, 这个相当于Windows上的FUSE, 需要在客机提前安装好.
此外, 需要安装好virtiofs的客机驱动和服务. 这部分可以直接安装virtio驱动iso中的guest工具包.
安装后在services.msc中找到并开启virtiofs服务即可.</p></li><li><p>主机部分: 运行virtiofsd, 指定通讯用socket路径和共享文件路径即可;
在对应的Qemu参数中, 配置好共享内存和socket, 并添加<code>vhost-user-fs-pci</code>设备.</p></li></ul><h2 id=其它>其它</h2><ul><li><code>-rtc base=localtime</code>: 由于Windows默认认为硬件时钟是本地时区. 因此将模拟的硬件时钟设为本地时区. (假设客户机的时区和本机相同)</li><li><code>-device virtio-balloon</code>: ballon设备帮助qemu主进程释放客户机空闲的内存.</li></ul><h1 id=结果>结果</h1><p><img src=/p/qemu-windows-guest-best-practices/qemu-win11.png width=2052 height=1266 srcset="/p/qemu-windows-guest-best-practices/qemu-win11_hu_b95aaa0eca8a7989.png 480w, /p/qemu-windows-guest-best-practices/qemu-win11_hu_3b0e49b92f43ddca.png 1024w" loading=lazy alt="运行Windows 11" class=gallery-image data-flex-grow=162 data-flex-basis=389px></p></section><footer class=article-footer><section class=article-tags><a href=/tags/qemu/>Qemu</a>
<a href=/tags/windows/>Windows</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Jul 06, 2025 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/emulating-arm-on-qemu-with-uefi/><div class=article-details><h2 class=article-title>Emulating ARM on QEMU, with UEFI</h2></div></a></article><article><a href=/p/fork2-and-the-oom-killer/><div class=article-details><h2 class=article-title>Fork(2) and the OOM killer</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Kya's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>