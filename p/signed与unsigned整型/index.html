<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Signed or unsigned? 在C与C++编程中的一个经典又经常被误解的问题是, 应当使用signed还是unsigned整数类型? 这个问题很早就有标准答案:\nC++核心规范: Arithmetic - ES.100 - ES.107 You should not use the unsigned integer types such as uint32_t, unless there is a valid reason such as representing a bit pattern rather than a number, or you need defined overflow modulo $2^N$.\u00a0In particular, do not use unsigned types to say a number will never be negative. Instead, use assertions for this.\nSubscripts and sizes should be signed - Bjarne Stroustrup 即: 只要是有算数意义的数字, 除非一些例外情况, 都应当使用signed整型. 算数意义是指, 这个数字如果被用于加减乘除等数学运算或者比较大小, 是有意义的.\n"><title>Signed与Unsigned整型</title><link rel=canonical href=https://kya8.github.io/p/signed%E4%B8%8Eunsigned%E6%95%B4%E5%9E%8B/><link rel=stylesheet href=/scss/style.min.8659d82dbe8d0fe183ef22445ed42765c7d1d996ae5b4a02725eda69426286da.css><meta property='og:title' content="Signed与Unsigned整型"><meta property='og:description' content="Signed or unsigned? 在C与C++编程中的一个经典又经常被误解的问题是, 应当使用signed还是unsigned整数类型? 这个问题很早就有标准答案:\nC++核心规范: Arithmetic - ES.100 - ES.107 You should not use the unsigned integer types such as uint32_t, unless there is a valid reason such as representing a bit pattern rather than a number, or you need defined overflow modulo $2^N$.\u00a0In particular, do not use unsigned types to say a number will never be negative. Instead, use assertions for this.\nSubscripts and sizes should be signed - Bjarne Stroustrup 即: 只要是有算数意义的数字, 除非一些例外情况, 都应当使用signed整型. 算数意义是指, 这个数字如果被用于加减乘除等数学运算或者比较大小, 是有意义的.\n"><meta property='og:url' content='https://kya8.github.io/p/signed%E4%B8%8Eunsigned%E6%95%B4%E5%9E%8B/'><meta property='og:site_name' content="Kya's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='c++'><meta property='article:tag' content='c'><meta property='article:published_time' content='2024-08-02T00:00:00+00:00'><meta property='article:modified_time' content='2024-08-02T00:00:00+00:00'><meta name=twitter:title content="Signed与Unsigned整型"><meta name=twitter:description content="Signed or unsigned? 在C与C++编程中的一个经典又经常被误解的问题是, 应当使用signed还是unsigned整数类型? 这个问题很早就有标准答案:\nC++核心规范: Arithmetic - ES.100 - ES.107 You should not use the unsigned integer types such as uint32_t, unless there is a valid reason such as representing a bit pattern rather than a number, or you need defined overflow modulo $2^N$.\u00a0In particular, do not use unsigned types to say a number will never be negative. Instead, use assertions for this.\nSubscripts and sizes should be signed - Bjarne Stroustrup 即: 只要是有算数意义的数字, 除非一些例外情况, 都应当使用signed整型. 算数意义是指, 这个数字如果被用于加减乘除等数学运算或者比较大小, 是有意义的.\n"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/>Kya's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/kya8 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#signed-or-unsigned>Signed or unsigned?</a></li><li><a href=#理由和例子>理由和例子</a><ol><li><a href=#非负逻辑>非负逻辑</a></li><li><a href=#混用signed与unsigned>混用signed与unsigned</a></li><li><a href=#优化>优化</a></li><li><a href=#其它>其它</a></li></ol></li><li><a href=#例外情况>例外情况</a><ol><li><a href=#非算数意义>非算数意义</a><ol><li><a href=#bitbyte-位操作>bit/byte, 位操作</a></li><li><a href=#其它-1>其它</a></li></ol></li><li><a href=#需要额外的1-bit位宽范围--省空间>需要额外的1-bit位宽范围 / 省空间</a><ol><li><a href=#char--signed-char--unsigned-char>char / signed char / unsigned char</a></li></ol></li><li><a href=#需要wrap-aroundmodular逻辑>需要wrap-around/modular逻辑</a></li><li><a href=#二进制序列化>二进制序列化</a></li></ol></li><li><a href=#rust>Rust</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/signed%E4%B8%8Eunsigned%E6%95%B4%E5%9E%8B/>Signed与Unsigned整型</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 02, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>2 minute read</time></div></footer></div></header><section class=article-content><h1 id=signed-or-unsigned>Signed or unsigned?</h1><p>在C与C++编程中的一个经典又经常被误解的问题是, 应当使用signed还是unsigned整数类型? 这个问题很早就有标准答案:</p><ul><li>C++核心规范: <a class=link href=https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#arithmetic target=_blank rel=noopener>Arithmetic - ES.100 - ES.107</a><blockquote><p>You should not use the unsigned integer types such as <code>uint32_t</code>, unless there is a valid reason such as representing a bit pattern rather than a number, or you need defined overflow modulo $2^N$. <strong>In particular, do not use unsigned types to say a number will never be negative. Instead, use assertions for this</strong>.</p></blockquote></li><li><a class=link href=https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1428r0.pdf target=_blank rel=noopener>Subscripts and sizes should be signed - Bjarne Stroustrup</a></li></ul><p>即: 只要是有<strong>算数意义</strong>的数字, 除非一些例外情况, 都应当使用signed整型. 算数意义是指, 这个数字如果被用于加减乘除等数学运算或者比较大小, 是有意义的.</p><h1 id=理由和例子>理由和例子</h1><h2 id=非负逻辑>非负逻辑</h2><p><strong>尤其是, 不要用unsigned整型来表示一个数字逻辑上不能是负数.</strong> 这可能是初学者最常见的错误. 这种情况应该在设计时用contract/pre-condition/post-condition来表示, 并在实现代码内用assert来检查.</p><p>例如, 一个函数的参数需要接收一个带有算数意义的整型, 且逻辑上不能为负数. 如果使用Unsigned整型, 调用者传入负数, 那么实际得到的实参也只会被wrap成一个<strong>无有效意义的</strong>正数,
此时函数内甚至无法判断调用者是不小心传入了负数, 还是真的mean to传入这个被wrap的正数. 并且这个wrap过程是well-defined, 并不能被ubsan之类的工具抓到.</p><p>关于这一条, 最常见的例子就是数组的下标, offset, 以及数组大小. 但在C与C++标准库, 以及其它的OS原生API中, 基本都是用<code>size_t</code>来表示.</p><ul><li>POSIX规定了<code>ssize_t</code>, 但这个类型仅仅是用来保证能够返回表示错误的一个sentinel值, 它保证能表示的负数只有-1. (当然, 实际上它一般就是<code>size_t</code>的signed版本, 即<code>std::make_signed_t&lt;size_t></code>).</li></ul><p>C++标准库中的index与size类型为<code>size_t</code>也可以归为历史遗留问题. 对于自己的代码, 建议使用<code>std::ptrdiff_t</code>或者<code>gsl::index</code>.</p><h2 id=混用signed与unsigned>混用signed与unsigned</h2><p>由于C与C++中关于算术操作的类型转换规则, 在算数操作中混用signed和unsigned整型可能会导致一些不直观的后果,
例如最简单的<code>unsigned(1) &lt; int(-1)</code>.</p><p>至于为什么不用unsigned arithmetics, 理由是unsigned整形的算数规则并不直观(如wrap-around), 容易silently导致错误, 难以发现. 并且缺少负数的算术操作也不方便. 如上一点所说, 这类silent的错误经常无法分辨, 对于溢出类错误(严格说, unsigned整型不存在overflow, 超出范围只有well-defined的wrap-around)尽管不会UB, 但也没有任何帮助, 只会让程序带着错误的数据silently继续运行, 引发不可预测的后果. UB至少还可以用一些工具抓到.</p><h2 id=优化>优化</h2><p>signed整形的overflow是UB, 这一点使得编译器能更好的优化, 例如一些index循环. 关于这一点, 引用Zig的一段介绍:</p><blockquote><p>Carefully chosen undefined behavior. For example, in Zig both signed and unsigned integers have undefined behavior on overflow, contrasted to only signed integers in C. This <a class=link href=https://godbolt.org/z/n_nLEU target=_blank rel=noopener>facilitates optimizations that are not available in C</a>.</p><p>- <a class=link href=https://ziglang.org/learn/overview target=_blank rel=noopener>ziglang overview</a></p></blockquote><p>当然, 在Release build里, UB的后果不可预测, 因此, 最好用一些额外手段确保安全, 例如使用checked arithmetics, 产生溢出错误就直接abort, 或者逻辑上确保不会出现overflow.</p><p><strong>无论如何, 用wrap-around的做法逃避算数溢出都不是一个解决方案!</strong></p><h2 id=其它>其它</h2><p>对于正常逻辑上非负的数字, 使用signed整形就多出了负数的范围, 可用来作为sentinel值返回错误. 这是十分常见的做法.
至于这种做法本身适不适合(相比于<code>std::optional</code>等其它方式), 属于另一个问题.</p><h1 id=例外情况>例外情况</h1><p>这些情况下, 可以允许(或必要)使用unsigned</p><h2 id=非算数意义>非算数意义</h2><h3 id=bitbyte-位操作>bit/byte, 位操作</h3><p>众所周知, 如果我们只关心访问一串byte, 此时应该使用<code>unsigned char</code>来表示字节. 此外, 对于位操作, unsigned整数也更加方便, 例如用于表示一个bit-field.</p><h3 id=其它-1>其它</h3><p>作为一个无算数意义的标记使用. 例如, 一个64位的hash函数一般返回<code>uint64_t</code>. 还有一些格式里的<code>FOURCC</code>标记等magic number.
一个随机发生器的原始输出一般也是unsigned, 作为一串随机的bit使用.</p><h2 id=需要额外的1-bit位宽范围--省空间>需要额外的1-bit位宽范围 / 省空间</h2><p>对于32位, 64位的整形, signed整形正数部分少掉的这一位位宽一般不是问题.
但是, 如果我们要表示0-255范围的数字, 那就需要用<code>uint8_t</code>(不考虑<code>CHAR_BIT > 8</code>的情况), 否则就需要两倍大小. 这种情况下额外的1-bit位宽就matter了.
8bit图像的表示就是常见的例子, 这里的数值显然是具有算数意义的.</p><h3 id=char--signed-char--unsigned-char>char / signed char / unsigned char</h3><p>注意区分这三个不同的基础类型. <code>unsigned char</code>表示raw字节. <code>signed char</code>用于带符号的算数数值. 如上所述, 为了正数位宽也可使用<code>unsigned char</code>. <code>char</code>应仅用于字符, 不应依赖它实际是signed还是unsigned.</p><h2 id=需要wrap-aroundmodular逻辑>需要wrap-around/modular逻辑</h2><p>比较少见, 但有时我们事实上确实需要用到wrap-around/modular逻辑&mldr;</p><h2 id=二进制序列化>二进制序列化</h2><p>二进制序列化需要统一的数值二进制表示.
不考虑端序, 对于正整数的表示一般没有异议, 但负整数可能存在差异(尽管也十分少见, 绝大多数平台都是2&rsquo;s complement表示).
因此, 二进制序列化/文件格式中, 对于非负的整数数值一般都是直接使用unsigned表示, 包括定点数的存储. 这样做也可以多出1-bit的正数位宽.</p><h1 id=rust>Rust</h1><p>这些规则大部分并不适用于Rust. Rust中基本的整数类型都适用于算数操作, 可以理解为它们只是具有不同的取值范围, 不允许隐式转换, 并且它们之间的显示转换也是安全的, <em>除了 <code>as</code></em>. 对于不安全的转换以及溢出行为, 可以选择使用wrap-around或者panick.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/c++/>C++</a>
<a href=/tags/c/>C</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/%E4%B8%8D%E7%94%A8%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0opaque-struct%E5%92%8Cpimpl/><div class=article-details><h2 class=article-title>不用动态内存分配如何实现opaque struct和PIMPL?</h2></div></a></article><article><a href=/p/portable-signal-handling/><div class=article-details><h2 class=article-title>Portable Signal handling</h2></div></a></article><article><a href=/p/pointers-again/><div class=article-details><h2 class=article-title>Pointers (again)</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 Kya's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>